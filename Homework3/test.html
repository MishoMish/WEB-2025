<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FMIHub Test Suite</title>
    <style>
      body {
        font-family: "Courier New", monospace;
        background: #1e1e1e;
        color: #d4d4d4;
        padding: 20px;
        margin: 0;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
      }
      h1 {
        color: #4ec9b0;
        border-bottom: 2px solid #4ec9b0;
        padding-bottom: 10px;
      }
      h2 {
        color: #569cd6;
        margin-top: 30px;
      }
      .test-suite {
        margin: 20px 0;
      }
      .test {
        padding: 8px 12px;
        margin: 5px 0;
        border-radius: 4px;
        display: flex;
        align-items: center;
      }
      .test.pass {
        background: rgba(78, 201, 176, 0.1);
        border-left: 4px solid #4ec9b0;
      }
      .test.fail {
        background: rgba(244, 71, 71, 0.1);
        border-left: 4px solid #f44747;
      }
      .test-icon {
        margin-right: 10px;
        font-weight: bold;
      }
      .test.pass .test-icon {
        color: #4ec9b0;
      }
      .test.fail .test-icon {
        color: #f44747;
      }
      .summary {
        margin-top: 30px;
        padding: 20px;
        background: rgba(78, 201, 176, 0.05);
        border-radius: 8px;
        border: 2px solid #4ec9b0;
      }
      .summary.fail {
        background: rgba(244, 71, 71, 0.05);
        border-color: #f44747;
      }
      .stats {
        display: flex;
        gap: 30px;
        margin-top: 10px;
      }
      .stat {
        font-size: 18px;
        font-weight: bold;
      }
      .stat.pass {
        color: #4ec9b0;
      }
      .stat.fail {
        color: #f44747;
      }
      .stat.total {
        color: #569cd6;
      }
      .error-detail {
        color: #ce9178;
        font-size: 12px;
        margin-left: 30px;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>üß™ FMIHub Registration Form - Full Test Coverage</h1>
      <p style="color: #9cdcfe; margin-bottom: 20px">
        Testing all validators, database username checks (10 users), API
        integration, and complete workflow
      </p>
      <div id="test-output"></div>
      <div id="summary"></div>
    </div>

    <script>
      // Test framework
      class TestRunner {
        constructor() {
          this.tests = [];
          this.passed = 0;
          this.failed = 0;
        }

        test(description, fn) {
          this.tests.push({ description, fn });
        }

        assertEqual(actual, expected, message = "") {
          if (actual !== expected) {
            throw new Error(
              `${message}\nExpected: ${expected}\nActual: ${actual}`
            );
          }
        }

        assertNotEqual(actual, expected, message = "") {
          if (actual === expected) {
            throw new Error(`${message}\nExpected not to be: ${expected}`);
          }
        }

        assertTrue(value, message = "") {
          if (!value) {
            throw new Error(
              `${message}\nExpected truthy value but got: ${value}`
            );
          }
        }

        assertFalse(value, message = "") {
          if (value) {
            throw new Error(
              `${message}\nExpected falsy value but got: ${value}`
            );
          }
        }

        assertNull(value, message = "") {
          if (value !== null) {
            throw new Error(`${message}\nExpected null but got: ${value}`);
          }
        }

        async run() {
          const output = document.getElementById("test-output");

          for (const test of this.tests) {
            try {
              await test.fn.call(this);
              this.passed++;
              output.innerHTML += `
                            <div class="test pass">
                                <span class="test-icon">‚úì</span>
                                <span>${test.description}</span>
                            </div>
                        `;
            } catch (error) {
              this.failed++;
              output.innerHTML += `
                            <div class="test fail">
                                <span class="test-icon">‚úó</span>
                                <span>${test.description}</span>
                            </div>
                            <div class="error-detail">${error.message}</div>
                        `;
            }
          }

          this.showSummary();
        }

        showSummary() {
          const total = this.passed + this.failed;
          const percentage = ((this.passed / total) * 100).toFixed(1);
          const summaryDiv = document.getElementById("summary");
          const status = this.failed === 0 ? "pass" : "fail";

          summaryDiv.innerHTML = `
                    <div class="summary ${status}">
                        <h2>üìä Test Summary</h2>
                        <div class="stats">
                            <div class="stat total">Total: ${total}</div>
                            <div class="stat pass">Passed: ${this.passed}</div>
                            <div class="stat fail">Failed: ${this.failed}</div>
                            <div class="stat">Coverage: ${percentage}%</div>
                        </div>
                    </div>
                `;
        }
      }

      // Mock database users (from JSONPlaceholder)
      const mockUsers = [
        {
          id: 1,
          name: "Leanne Graham",
          username: "Bret",
          email: "Sincere@april.biz",
        },
        {
          id: 2,
          name: "Ervin Howell",
          username: "Antonette",
          email: "Shanna@melissa.tv",
        },
        {
          id: 3,
          name: "Clementine Bauch",
          username: "Samantha",
          email: "Nathan@yesenia.net",
        },
        {
          id: 4,
          name: "Patricia Lebsack",
          username: "Karianne",
          email: "Julianne.OConner@kory.org",
        },
        {
          id: 5,
          name: "Chelsey Dietrich",
          username: "Kamren",
          email: "Lucio_Hettinger@annie.ca",
        },
        {
          id: 6,
          name: "Mrs. Dennis Schulist",
          username: "Leopoldo_Corkery",
          email: "Karley_Dach@jasper.info",
        },
        {
          id: 7,
          name: "Kurtis Weissnat",
          username: "Elwyn.Skiles",
          email: "Telly.Hoeger@billy.biz",
        },
        {
          id: 8,
          name: "Nicholas Runolfsdottir V",
          username: "Maxime_Nienow",
          email: "Sherwood@rosamond.me",
        },
        {
          id: 9,
          name: "Glenna Reichert",
          username: "Delphine",
          email: "Chaim_McDermott@dana.io",
        },
        {
          id: 10,
          name: "Clementina DuBuque",
          username: "Moriah.Stanton",
          email: "Rey.Padberg@karina.biz",
        },
      ];

      // Check if username exists function (copy from script.js)
      const checkUsernameExists = (username, users) => {
        return users.some(
          (user) => user.username.toLowerCase() === username.toLowerCase()
        );
      };

      // Fetch users function
      const fetchUsers = async () => {
        try {
          const response = await fetch(
            "https://jsonplaceholder.typicode.com/users"
          );
          if (!response.ok) {
            throw new Error("–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ —Å—ä—Å —Å—ä—Ä–≤—ä—Ä–∞");
          }
          const users = await response.json();
          return users;
        } catch (error) {
          throw new Error(
            "–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∏–∑–≤–ª–∏—á–∞–Ω–µ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏: " + error.message
          );
        }
      };

      // Create validators (copy from script.js)
      const validators = {
        username: (value) => {
          if (!value || value.trim() === "") {
            return "–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ—Ç–æ –∏–º–µ –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ –ø–æ–ª–µ";
          }
          const trimmedValue = value.trim();
          if (trimmedValue.length < 3 || trimmedValue.length > 10) {
            return "–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ—Ç–æ –∏–º–µ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –º–µ–∂–¥—É 3 –∏ 10 —Å–∏–º–≤–æ–ª–∞";
          }
          return null;
        },

        name: (value) => {
          if (!value || value.trim() === "") {
            return "–ò–º–µ—Ç–æ –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ –ø–æ–ª–µ";
          }
          const trimmedValue = value.trim();
          if (trimmedValue.length > 50) {
            return "–ò–º–µ—Ç–æ –Ω–µ –º–æ–∂–µ –¥–∞ –µ –ø–æ–≤–µ—á–µ –æ—Ç 50 —Å–∏–º–≤–æ–ª–∞";
          }
          return null;
        },

        familyName: (value) => {
          if (!value || value.trim() === "") {
            return "–§–∞–º–∏–ª–∏—è—Ç–∞ –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ –ø–æ–ª–µ";
          }
          const trimmedValue = value.trim();
          if (trimmedValue.length > 50) {
            return "–§–∞–º–∏–ª–∏—è—Ç–∞ –Ω–µ –º–æ–∂–µ –¥–∞ –µ –ø–æ–≤–µ—á–µ –æ—Ç 50 —Å–∏–º–≤–æ–ª–∞";
          }
          return null;
        },

        email: (value) => {
          if (!value || value.trim() === "") {
            return "–ò–º–µ–π–ª—ä—Ç –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ –ø–æ–ª–µ";
          }
          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailRegex.test(value)) {
            return "–ú–æ–ª—è, –≤—ä–≤–µ–¥–µ—Ç–µ –≤–∞–ª–∏–¥–µ–Ω –∏–º–µ–π–ª –∞–¥—Ä–µ—Å";
          }
          return null;
        },

        password: (value) => {
          if (!value || value.trim() === "") {
            return "–ü–∞—Ä–æ–ª–∞—Ç–∞ –µ –∑–∞–¥—ä–ª–∂–∏—Ç–µ–ª–Ω–æ –ø–æ–ª–µ";
          }
          const trimmedValue = value.trim();
          if (trimmedValue.length < 6 || trimmedValue.length > 10) {
            return "–ü–∞—Ä–æ–ª–∞—Ç–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –º–µ–∂–¥—É 6 –∏ 10 —Å–∏–º–≤–æ–ª–∞";
          }
          const hasUpperCase = /[A-Z]/.test(trimmedValue);
          const hasLowerCase = /[a-z]/.test(trimmedValue);
          const hasDigit = /[0-9]/.test(trimmedValue);

          if (!hasUpperCase || !hasLowerCase || !hasDigit) {
            return "–ü–∞—Ä–æ–ª–∞—Ç–∞ —Ç—Ä—è–±–≤–∞ –¥–∞ —Å—ä–¥—ä—Ä–∂–∞ –≥–ª–∞–≤–Ω–∏ –∏ –º–∞–ª–∫–∏ –±—É–∫–≤–∏ –∏ —Ü–∏—Ñ—Ä–∏";
          }
          return null;
        },

        postalCode: (value) => {
          if (!value || value.trim() === "") {
            return null;
          }
          const postalCodeRegex = /^(\d{4})$|^(\d{5}-\d{4})$/;
          if (!postalCodeRegex.test(value)) {
            return "–ü–æ—â–µ–Ω—Å–∫–∏—è—Ç –∫–æ–¥ —Ç—Ä—è–±–≤–∞ –¥–∞ –µ –≤—ä–≤ —Ñ–æ—Ä–º–∞—Ç 1111 –∏–ª–∏ 11111-1111";
          }
          return null;
        },
      };

      // Run tests
      const runner = new TestRunner();

      // ============= USERNAME VALIDATION TESTS =============
      runner.test("Username: Rejects empty string", function () {
        const result = validators.username("");
        this.assertNotEqual(result, null, "Empty username should return error");
      });

      runner.test("Username: Rejects whitespace only", function () {
        const result = validators.username("   ");
        this.assertNotEqual(
          result,
          null,
          "Whitespace username should return error"
        );
      });

      runner.test("Username: Rejects less than 3 characters", function () {
        const result = validators.username("ab");
        this.assertNotEqual(
          result,
          null,
          "Username with 2 chars should return error"
        );
      });

      runner.test("Username: Rejects more than 10 characters", function () {
        const result = validators.username("12345678901");
        this.assertNotEqual(
          result,
          null,
          "Username with 11 chars should return error"
        );
      });

      runner.test("Username: Accepts valid 3 character username", function () {
        const result = validators.username("abc");
        this.assertNull(result, "Valid 3-char username should pass");
      });

      runner.test("Username: Accepts valid 10 character username", function () {
        const result = validators.username("abcdefghij");
        this.assertNull(result, "Valid 10-char username should pass");
      });

      runner.test(
        "Username: Accepts valid username with spaces trimmed",
        function () {
          const result = validators.username("  user123  ");
          this.assertNull(result, "Username with trimmed spaces should pass");
        }
      );

      // ============= NAME VALIDATION TESTS =============
      runner.test("Name: Rejects empty string", function () {
        const result = validators.name("");
        this.assertNotEqual(result, null, "Empty name should return error");
      });

      runner.test("Name: Rejects whitespace only", function () {
        const result = validators.name("   ");
        this.assertNotEqual(
          result,
          null,
          "Whitespace name should return error"
        );
      });

      runner.test("Name: Rejects more than 50 characters", function () {
        const result = validators.name("a".repeat(51));
        this.assertNotEqual(
          result,
          null,
          "Name with 51 chars should return error"
        );
      });

      runner.test("Name: Accepts valid name", function () {
        const result = validators.name("–ò–≤–∞–Ω");
        this.assertNull(result, "Valid name should pass");
      });

      runner.test("Name: Accepts 50 character name", function () {
        const result = validators.name("a".repeat(50));
        this.assertNull(result, "Name with exactly 50 chars should pass");
      });

      // ============= FAMILY NAME VALIDATION TESTS =============
      runner.test("Family Name: Rejects empty string", function () {
        const result = validators.familyName("");
        this.assertNotEqual(
          result,
          null,
          "Empty family name should return error"
        );
      });

      runner.test("Family Name: Rejects whitespace only", function () {
        const result = validators.familyName("   ");
        this.assertNotEqual(
          result,
          null,
          "Whitespace family name should return error"
        );
      });

      runner.test("Family Name: Rejects more than 50 characters", function () {
        const result = validators.familyName("b".repeat(51));
        this.assertNotEqual(
          result,
          null,
          "Family name with 51 chars should return error"
        );
      });

      runner.test("Family Name: Accepts valid family name", function () {
        const result = validators.familyName("–ü–µ—Ç—Ä–æ–≤");
        this.assertNull(result, "Valid family name should pass");
      });

      runner.test("Family Name: Accepts 50 character family name", function () {
        const result = validators.familyName("b".repeat(50));
        this.assertNull(
          result,
          "Family name with exactly 50 chars should pass"
        );
      });

      // ============= EMAIL VALIDATION TESTS =============
      runner.test("Email: Rejects empty string", function () {
        const result = validators.email("");
        this.assertNotEqual(result, null, "Empty email should return error");
      });

      runner.test("Email: Rejects invalid format without @", function () {
        const result = validators.email("invalidemail.com");
        this.assertNotEqual(
          result,
          null,
          "Email without @ should return error"
        );
      });

      runner.test("Email: Rejects invalid format without domain", function () {
        const result = validators.email("test@");
        this.assertNotEqual(
          result,
          null,
          "Email without domain should return error"
        );
      });

      runner.test("Email: Rejects invalid format without TLD", function () {
        const result = validators.email("test@example");
        this.assertNotEqual(
          result,
          null,
          "Email without TLD should return error"
        );
      });

      runner.test("Email: Accepts valid email", function () {
        const result = validators.email("test@example.com");
        this.assertNull(result, "Valid email should pass");
      });

      runner.test("Email: Accepts email with subdomain", function () {
        const result = validators.email("user@mail.fmi.uni-sofia.bg");
        this.assertNull(result, "Email with subdomain should pass");
      });

      runner.test("Email: Accepts email with numbers", function () {
        const result = validators.email("user123@test456.com");
        this.assertNull(result, "Email with numbers should pass");
      });

      // ============= PASSWORD VALIDATION TESTS =============
      runner.test("Password: Rejects empty string", function () {
        const result = validators.password("");
        this.assertNotEqual(result, null, "Empty password should return error");
      });

      runner.test("Password: Rejects less than 6 characters", function () {
        const result = validators.password("Abc12");
        this.assertNotEqual(
          result,
          null,
          "Password with 5 chars should return error"
        );
      });

      runner.test("Password: Rejects more than 10 characters", function () {
        const result = validators.password("Abcdefgh123");
        this.assertNotEqual(
          result,
          null,
          "Password with 11 chars should return error"
        );
      });

      runner.test("Password: Rejects without uppercase", function () {
        const result = validators.password("abcdef123");
        this.assertNotEqual(
          result,
          null,
          "Password without uppercase should return error"
        );
      });

      runner.test("Password: Rejects without lowercase", function () {
        const result = validators.password("ABCDEF123");
        this.assertNotEqual(
          result,
          null,
          "Password without lowercase should return error"
        );
      });

      runner.test("Password: Rejects without digits", function () {
        const result = validators.password("Abcdefgh");
        this.assertNotEqual(
          result,
          null,
          "Password without digits should return error"
        );
      });

      runner.test(
        "Password: Accepts valid password with all requirements",
        function () {
          const result = validators.password("Password1");
          this.assertNull(result, "Valid password should pass");
        }
      );

      runner.test("Password: Accepts 6 character valid password", function () {
        const result = validators.password("Pass12");
        this.assertNull(result, "Valid 6-char password should pass");
      });

      runner.test("Password: Accepts 10 character valid password", function () {
        const result = validators.password("Password12");
        this.assertNull(result, "Valid 10-char password should pass");
      });

      // ============= POSTAL CODE VALIDATION TESTS =============
      runner.test(
        "Postal Code: Accepts empty string (optional field)",
        function () {
          const result = validators.postalCode("");
          this.assertNull(result, "Empty postal code should pass (optional)");
        }
      );

      runner.test(
        "Postal Code: Accepts whitespace (optional field)",
        function () {
          const result = validators.postalCode("   ");
          this.assertNull(
            result,
            "Whitespace postal code should pass (optional)"
          );
        }
      );

      runner.test("Postal Code: Accepts valid 4-digit format", function () {
        const result = validators.postalCode("1234");
        this.assertNull(result, "Valid 4-digit postal code should pass");
      });

      runner.test(
        "Postal Code: Accepts valid 9-digit format with dash",
        function () {
          const result = validators.postalCode("12345-6789");
          this.assertNull(result, "Valid 9-digit postal code should pass");
        }
      );

      runner.test("Postal Code: Rejects 3-digit code", function () {
        const result = validators.postalCode("123");
        this.assertNotEqual(
          result,
          null,
          "3-digit postal code should return error"
        );
      });

      runner.test(
        "Postal Code: Rejects 5-digit code without dash",
        function () {
          const result = validators.postalCode("12345");
          this.assertNotEqual(
            result,
            null,
            "5-digit postal code should return error"
          );
        }
      );

      runner.test(
        "Postal Code: Rejects invalid format with letters",
        function () {
          const result = validators.postalCode("12A4");
          this.assertNotEqual(
            result,
            null,
            "Postal code with letters should return error"
          );
        }
      );

      runner.test("Postal Code: Rejects wrong dash position", function () {
        const result = validators.postalCode("1234-56789");
        this.assertNotEqual(
          result,
          null,
          "Postal code with wrong dash should return error"
        );
      });

      // ============= EDGE CASES =============
      runner.test("Username: Handles null input", function () {
        const result = validators.username(null);
        this.assertNotEqual(result, null, "Null username should return error");
      });

      runner.test("Username: Handles undefined input", function () {
        const result = validators.username(undefined);
        this.assertNotEqual(
          result,
          null,
          "Undefined username should return error"
        );
      });

      runner.test("Email: Handles multiple @ symbols", function () {
        const result = validators.email("test@@example.com");
        this.assertNotEqual(
          result,
          null,
          "Email with multiple @ should return error"
        );
      });

      runner.test("Password: Handles special characters", function () {
        const result = validators.password("Pass@123");
        this.assertNull(
          result,
          "Password with special chars should pass if it meets other requirements"
        );
      });

      runner.test(
        'DB Check: Detects existing username "Bret" (case-sensitive)',
        function () {
          const exists = checkUsernameExists("Bret", mockUsers);
          this.assertTrue(exists, 'Username "Bret" should exist in database');
        }
      );

      runner.test(
        'DB Check: Detects existing username "Antonette"',
        function () {
          const exists = checkUsernameExists("Antonette", mockUsers);
          this.assertTrue(
            exists,
            'Username "Antonette" should exist in database'
          );
        }
      );

      runner.test(
        'DB Check: Detects existing username "Samantha"',
        function () {
          const exists = checkUsernameExists("Samantha", mockUsers);
          this.assertTrue(
            exists,
            'Username "Samantha" should exist in database'
          );
        }
      );

      runner.test(
        'DB Check: Detects existing username "Karianne"',
        function () {
          const exists = checkUsernameExists("Karianne", mockUsers);
          this.assertTrue(
            exists,
            'Username "Karianne" should exist in database'
          );
        }
      );

      runner.test('DB Check: Detects existing username "Kamren"', function () {
        const exists = checkUsernameExists("Kamren", mockUsers);
        this.assertTrue(exists, 'Username "Kamren" should exist in database');
      });

      runner.test(
        'DB Check: Detects existing username "Leopoldo_Corkery"',
        function () {
          const exists = checkUsernameExists("Leopoldo_Corkery", mockUsers);
          this.assertTrue(
            exists,
            'Username "Leopoldo_Corkery" should exist in database'
          );
        }
      );

      runner.test(
        'DB Check: Detects existing username "Elwyn.Skiles"',
        function () {
          const exists = checkUsernameExists("Elwyn.Skiles", mockUsers);
          this.assertTrue(
            exists,
            'Username "Elwyn.Skiles" should exist in database'
          );
        }
      );

      runner.test(
        'DB Check: Detects existing username "Maxime_Nienow"',
        function () {
          const exists = checkUsernameExists("Maxime_Nienow", mockUsers);
          this.assertTrue(
            exists,
            'Username "Maxime_Nienow" should exist in database'
          );
        }
      );

      runner.test(
        'DB Check: Detects existing username "Delphine"',
        function () {
          const exists = checkUsernameExists("Delphine", mockUsers);
          this.assertTrue(
            exists,
            'Username "Delphine" should exist in database'
          );
        }
      );

      runner.test(
        'DB Check: Detects existing username "Moriah.Stanton"',
        function () {
          const exists = checkUsernameExists("Moriah.Stanton", mockUsers);
          this.assertTrue(
            exists,
            'Username "Moriah.Stanton" should exist in database'
          );
        }
      );

      runner.test(
        'DB Check: Case-insensitive detection - "BRET" should match "Bret"',
        function () {
          const exists = checkUsernameExists("BRET", mockUsers);
          this.assertTrue(exists, "Username check should be case-insensitive");
        }
      );

      runner.test(
        'DB Check: Case-insensitive detection - "antonette" should match "Antonette"',
        function () {
          const exists = checkUsernameExists("antonette", mockUsers);
          this.assertTrue(
            exists,
            "Username check should be case-insensitive (lowercase)"
          );
        }
      );

      runner.test(
        'DB Check: Case-insensitive detection - "SaMaNtHa" should match "Samantha"',
        function () {
          const exists = checkUsernameExists("SaMaNtHa", mockUsers);
          this.assertTrue(
            exists,
            "Username check should be case-insensitive (mixed case)"
          );
        }
      );

      runner.test(
        'DB Check: Returns false for non-existing username "NewUser123"',
        function () {
          const exists = checkUsernameExists("NewUser123", mockUsers);
          this.assertFalse(exists, "Non-existing username should return false");
        }
      );

      runner.test(
        'DB Check: Returns false for non-existing username "TestUser"',
        function () {
          const exists = checkUsernameExists("TestUser", mockUsers);
          this.assertFalse(exists, "Non-existing username should return false");
        }
      );

      runner.test("DB Check: Returns false for empty username", function () {
        const exists = checkUsernameExists("", mockUsers);
        this.assertFalse(exists, "Empty username should return false");
      });

      runner.test(
        'DB Check: Returns false for partial username match "Bre"',
        function () {
          const exists = checkUsernameExists("Bre", mockUsers);
          this.assertFalse(exists, "Partial username should not match");
        }
      );

      runner.test(
        'DB Check: Returns false for username with extra characters "Bret123"',
        function () {
          const exists = checkUsernameExists("Bret123", mockUsers);
          this.assertFalse(
            exists,
            "Username with extra characters should not match"
          );
        }
      );

      // ============= API INTEGRATION TESTS =============
      runner.test(
        "API: Can fetch users from JSONPlaceholder",
        async function () {
          try {
            const users = await fetchUsers();
            this.assertTrue(
              Array.isArray(users),
              "Fetched data should be an array"
            );
            this.assertTrue(
              users.length === 10,
              "Should fetch exactly 10 users"
            );
          } catch (error) {
            throw new Error("Failed to fetch users from API: " + error.message);
          }
        }
      );

      runner.test(
        "API: Fetched users have correct structure",
        async function () {
          try {
            const users = await fetchUsers();
            const firstUser = users[0];
            this.assertTrue("id" in firstUser, "User should have id property");
            this.assertTrue(
              "username" in firstUser,
              "User should have username property"
            );
            this.assertTrue(
              "email" in firstUser,
              "User should have email property"
            );
            this.assertTrue(
              "name" in firstUser,
              "User should have name property"
            );
          } catch (error) {
            throw new Error(
              "Failed to validate user structure: " + error.message
            );
          }
        }
      );

      runner.test('API: First user is "Bret"', async function () {
        try {
          const users = await fetchUsers();
          this.assertEqual(
            users[0].username,
            "Bret",
            'First user should be "Bret"'
          );
        } catch (error) {
          throw new Error("Failed to verify first user: " + error.message);
        }
      });

      runner.test(
        "API: All 10 usernames from database are present",
        async function () {
          try {
            const users = await fetchUsers();
            const expectedUsernames = [
              "Bret",
              "Antonette",
              "Samantha",
              "Karianne",
              "Kamren",
              "Leopoldo_Corkery",
              "Elwyn.Skiles",
              "Maxime_Nienow",
              "Delphine",
              "Moriah.Stanton",
            ];

            expectedUsernames.forEach((username) => {
              const found = users.some((u) => u.username === username);
              if (!found) {
                throw new Error(
                  `Username "${username}" not found in API response`
                );
              }
            });
            this.assertTrue(true, "All expected usernames present");
          } catch (error) {
            throw new Error("Failed to verify all usernames: " + error.message);
          }
        }
      );

      runner.test(
        'API: checkUsernameExists works with real API data for "Bret"',
        async function () {
          try {
            const users = await fetchUsers();
            const exists = checkUsernameExists("Bret", users);
            this.assertTrue(exists, "Bret should exist in real API data");
          } catch (error) {
            throw new Error(
              "Failed to check username against API: " + error.message
            );
          }
        }
      );

      runner.test(
        "API: checkUsernameExists works with real API data for new user",
        async function () {
          try {
            const users = await fetchUsers();
            const exists = checkUsernameExists("NewTestUser99", users);
            this.assertFalse(
              exists,
              "New username should not exist in API data"
            );
          } catch (error) {
            throw new Error(
              "Failed to check new username against API: " + error.message
            );
          }
        }
      );

      // ============= FULL INTEGRATION WORKFLOW TESTS =============
      runner.test(
        "Workflow: Valid form data with new username should pass validation",
        function () {
          const username = validators.username("newuser");
          const name = validators.name("–ò–≤–∞–Ω");
          const familyName = validators.familyName("–ü–µ—Ç—Ä–æ–≤");
          const email = validators.email("ivan@fmi.uni-sofia.bg");
          const password = validators.password("Pass123");

          this.assertNull(username, "Valid username should pass");
          this.assertNull(name, "Valid name should pass");
          this.assertNull(familyName, "Valid family name should pass");
          this.assertNull(email, "Valid email should pass");
          this.assertNull(password, "Valid password should pass");
        }
      );

      runner.test(
        "Workflow: Complete valid registration data structure",
        function () {
          const userData = {
            username: "testuser",
            name: "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤",
            email: "ivan@test.com",
            address: {
              street: "Test Street",
              city: "Sofia",
              zipcode: "1000",
            },
          };

          this.assertTrue(
            "username" in userData,
            "userData should have username"
          );
          this.assertTrue("name" in userData, "userData should have name");
          this.assertTrue("email" in userData, "userData should have email");
          this.assertTrue(
            "address" in userData,
            "userData should have address"
          );
        }
      );

      runner.test(
        "Workflow: Postal code format 4-digit is accepted",
        function () {
          const result = validators.postalCode("1000");
          this.assertNull(result, "4-digit postal code should be valid");
        }
      );

      runner.test(
        "Workflow: Postal code format 9-digit with dash is accepted",
        function () {
          const result = validators.postalCode("12345-6789");
          this.assertNull(
            result,
            "9-digit postal code with dash should be valid"
          );
        }
      );

      runner.test("Workflow: All required fields fail when empty", function () {
        const username = validators.username("");
        const name = validators.name("");
        const familyName = validators.familyName("");
        const email = validators.email("");
        const password = validators.password("");

        this.assertNotEqual(username, null, "Empty username should fail");
        this.assertNotEqual(name, null, "Empty name should fail");
        this.assertNotEqual(familyName, null, "Empty family name should fail");
        this.assertNotEqual(email, null, "Empty email should fail");
        this.assertNotEqual(password, null, "Empty password should fail");
      });

      runner.test(
        'Workflow: Existing username "Bret" should be detected',
        function () {
          const exists = checkUsernameExists("Bret", mockUsers);
          this.assertTrue(exists, "Existing username should be detected");
        }
      );

      runner.test("Workflow: FMI email format is accepted", function () {
        const result = validators.email("student@fmi.uni-sofia.bg");
        this.assertNull(result, "FMI email format should be valid");
      });

      runner.test(
        "Workflow: Bulgarian cyrillic names are accepted",
        function () {
          const name = validators.name("–ò–≤–∞–Ω");
          const familyName = validators.familyName("–ü–µ—Ç—Ä–æ–≤");
          this.assertNull(name, "Cyrillic name should be valid");
          this.assertNull(familyName, "Cyrillic family name should be valid");
        }
      );

      runner.test(
        "Username: Trims whitespace correctly (leading/trailing)",
        function () {
          const result = validators.username("  test  ");
          this.assertNull(
            result,
            "Username should trim and validate correctly"
          );
        }
      );

      runner.test("Name: Accepts names with special characters", function () {
        const result = validators.name("Jean-Pierre");
        this.assertNull(result, "Name with hyphen should pass");
      });

      runner.test("Email: Accepts plus addressing", function () {
        const result = validators.email("test+tag@example.com");
        this.assertNull(result, "Email with plus should pass");
      });

      runner.test(
        "Password: Edge case - exactly 6 chars with all requirements",
        function () {
          const result = validators.password("Aa1234");
          this.assertNull(
            result,
            "Minimum length password with all requirements should pass"
          );
        }
      );

      runner.test(
        "Password: Edge case - exactly 10 chars with all requirements",
        function () {
          const result = validators.password("Abcdefg123");
          this.assertNull(
            result,
            "Maximum length password with all requirements should pass"
          );
        }
      );

      runner.test(
        "Postal Code: Edge case - all zeros valid format",
        function () {
          const result = validators.postalCode("0000");
          this.assertNull(result, "All zeros postal code should pass");
        }
      );

      runner.test(
        "Postal Code: Edge case - all nines valid format",
        function () {
          const result = validators.postalCode("99999-9999");
          this.assertNull(result, "All nines postal code should pass");
        }
      );

      // Run all tests
      runner.run();
    </script>
  </body>
</html>
